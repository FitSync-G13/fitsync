version: 2.1

commands:
  build-scan-push:
    description: "Build, Scan, and Push Docker Image"
    parameters:
      service_name:
        type: string
      folder_path:
        type: string
    steps:
      - checkout
      
      - restore_cache:
          keys:
            - docker-{{ .Branch }}-{{ checksum "<< parameters.folder_path >>/Dockerfile" }}
            - docker-{{ .Branch }}
            - docker-main
      
      - run:
          name: Build Docker Image
          command: |
            export DOCKER_BUILDKIT=1
            docker build \
              --build-arg BUILD_DATE=$(date -u +'%Y-%m-%dT%H:%M:%SZ') \
              --build-arg VCS_REF=${CIRCLE_SHA1} \
              --build-arg VERSION=${CIRCLE_TAG:-${CIRCLE_SHA1:0:7}} \
              -t << parameters.service_name >>:${CIRCLE_SHA1} \
              -t << parameters.service_name >>:latest \
              << parameters.folder_path >>
      
      - save_cache:
          key: docker-{{ .Branch }}-{{ checksum "<< parameters.folder_path >>/Dockerfile" }}
          paths:
            - /var/lib/docker
      
      # --- FIX: Replaced 'cat <<EOF' with 'echo' to avoid syntax errors ---
      - run:
          name: Generate Build Info
          command: |
            mkdir -p /tmp/build-metadata
            FILE="/tmp/build-metadata/<< parameters.service_name >>-info.json"
            
            echo "{" > "$FILE"
            echo "  \"service\": \"<< parameters.service_name >>\"," >> "$FILE"
            echo "  \"commit\": \"${CIRCLE_SHA1}\"," >> "$FILE"
            echo "  \"branch\": \"${CIRCLE_BRANCH}\"," >> "$FILE"
            echo "  \"build_number\": \"${CIRCLE_BUILD_NUM}\"," >> "$FILE"
            echo "  \"build_url\": \"${CIRCLE_BUILD_URL}\"," >> "$FILE"
            echo "  \"build_time\": \"$(date -u +'%Y-%m-%dT%H:%M:%SZ')\"," >> "$FILE"
            echo "  \"repository\": \"${CIRCLE_PROJECT_REPONAME}\"" >> "$FILE"
            echo "}" >> "$FILE"
      
      - store_artifacts:
          path: /tmp/build-metadata
          destination: build-info
      
      - run:
          name: Install Trivy
          command: |
            curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sudo sh -s -- -b /usr/local/bin
      
      - run:
          name: Scan Image for Vulnerabilities
          command: |
            mkdir -p /tmp/trivy-reports
            
            trivy image \
              --format json \
              --output /tmp/trivy-reports/<< parameters.service_name >>-vulnerabilities.json \
              << parameters.service_name >>:${CIRCLE_SHA1}
            
            trivy image \
              --format table \
              --output /tmp/trivy-reports/<< parameters.service_name >>-vulnerabilities.txt \
              << parameters.service_name >>:${CIRCLE_SHA1}
            
            trivy image \
              --format sarif \
              --output /tmp/trivy-reports/<< parameters.service_name >>-vulnerabilities.sarif \
              << parameters.service_name >>:${CIRCLE_SHA1}
      
      - run:
          name: Generate SBOM
          command: |
            trivy image \
              --format cyclonedx \
              --output /tmp/trivy-reports/<< parameters.service_name >>-sbom.json \
              << parameters.service_name >>:${CIRCLE_SHA1}
            
            trivy image \
              --format spdx-json \
              --output /tmp/trivy-reports/<< parameters.service_name >>-sbom-spdx.json \
              << parameters.service_name >>:${CIRCLE_SHA1}
      
      - run:
          name: Scan for Misconfigurations
          command: |
            trivy config \
              --format json \
              --output /tmp/trivy-reports/<< parameters.service_name >>-misconfig.json \
              << parameters.folder_path >>
      
      - run:
          name: Scan for Secrets
          command: |
            trivy fs \
              --scanners secret \
              --format json \
              --output /tmp/trivy-reports/<< parameters.service_name >>-secrets.json \
              << parameters.folder_path >>
      
      - store_artifacts:
          path: /tmp/trivy-reports
          destination: security-reports
      
      - run:
          name: Check Security Thresholds
          command: |
            echo "Checking for HIGH and CRITICAL vulnerabilities..."
            trivy image \
              --exit-code 1 \
              --severity HIGH,CRITICAL \
              --ignore-unfixed \
              << parameters.service_name >>:${CIRCLE_SHA1}
      
      - run:
          name: Export Docker Image
          command: |
            mkdir -p /tmp/docker-images
            docker save << parameters.service_name >>:${CIRCLE_SHA1} | gzip > /tmp/docker-images/<< parameters.service_name >>.tar.gz
          when: on_success
      
      - store_artifacts:
          path: /tmp/docker-images
          destination: docker-images
      
      - run:
          name: Analyze Image Size
          command: |
            mkdir -p /tmp/image-analysis
            docker images << parameters.service_name >>:${CIRCLE_SHA1} > /tmp/image-analysis/size.txt
            # Using 'tee' instead of '>>' just to be extra safe with parsers, though >> is usually fine
            docker history << parameters.service_name >>:${CIRCLE_SHA1} | tee -a /tmp/image-analysis/layers.txt
      
      - store_artifacts:
          path: /tmp/image-analysis
          destination: image-analysis

executors:
  docker-builder:
    machine:
      image: ubuntu-2004:2024.01.2
    resource_class: medium
    environment:
      DOCKER_BUILDKIT: 1

jobs:
  build-gateway:
    executor: docker-builder
    steps:
      - when:
          condition:
            or:
              - << pipeline.parameters.run-api-gateway >>
              - << pipeline.parameters.trigger-all >>
          steps:
            - build-scan-push:
                service_name: "fitsync-api-gateway"
                folder_path: "./services/api-gateway"

  build-notification:
    executor: docker-builder
    steps:
      - when:
          condition:
            or:
              - << pipeline.parameters.run-notification-service >>
              - << pipeline.parameters.trigger-all >>
          steps:
            - build-scan-push:
                service_name: "fitsync-notification-service"
                folder_path: "./services/notification-service"

  build-progress:
    executor: docker-builder
    steps:
      - when:
          condition:
            or:
              - << pipeline.parameters.run-progress-service >>
              - << pipeline.parameters.trigger-all >>
          steps:
            - build-scan-push:
                service_name: "fitsync-progress-service"
                folder_path: "./services/progress-service"

  build-schedule:
    executor: docker-builder
    steps:
      - when:
          condition:
            or:
              - << pipeline.parameters.run-schedule-service >>
              - << pipeline.parameters.trigger-all >>
          steps:
            - build-scan-push:
                service_name: "fitsync-schedule-service"
                folder_path: "./services/schedule-service"

  build-training:
    executor: docker-builder
    steps:
      - when:
          condition:
            or:
              - << pipeline.parameters.run-training-service >>
              - << pipeline.parameters.trigger-all >>
          steps:
            - build-scan-push:
                service_name: "fitsync-training-service"
                folder_path: "./services/training-service"

  build-user:
    executor: docker-builder
    steps:
      - when:
          condition:
            or:
              - << pipeline.parameters.run-user-service >>
              - << pipeline.parameters.trigger-all >>
          steps:
            - build-scan-push:
                service_name: "fitsync-user-service"
                folder_path: "./services/user-service"

  build-frontend:
    executor: docker-builder
    steps:
      - when:
          condition:
            or:
              - << pipeline.parameters.run-frontend >>
              - << pipeline.parameters.trigger-all >>
          steps:
            - build-scan-push:
                service_name: "fitsync-frontend"
                folder_path: "./frontend"

parameters:
  run-api-gateway:
    type: boolean
    default: false
  run-notification-service:
    type: boolean
    default: false
  run-progress-service:
    type: boolean
    default: false
  run-schedule-service:
    type: boolean
    default: false
  run-training-service:
    type: boolean
    default: false
  run-user-service:
    type: boolean
    default: false
  run-frontend:
    type: boolean
    default: false
  trigger-all:
    type: boolean
    default: false

workflows:
  build_microservices:
    jobs:
      - build-gateway
      - build-notification
      - build-progress
      - build-schedule
      - build-training
      - build-user
      - build-frontend
